/*
    Copyright (c) 2016 eyeOS

    This file is part of Open365.

    Open365 is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program. If not, see <http://www.gnu.org/licenses/>.
*/

(function(){define("pathJoin",[],function(){function e(){var e=arguments[0].replace(/\/+$/,"");for(var t=1;t<arguments.length;t++)e+="/"+arguments[t].replace(/^\/+/,"");return e}return e}),define("../settings",["pathJoin"],function(e){var t={trash:"/users/%USER%/files/.Trash",home:"/users/%USER%/files",workgroup:"/users/%USER%/workgroups/%WORKGROUP%",network:"/users/%USER%/networkdrives",print:"/users/%USER%/print",local:"/users/%USER%/local",_workgroupIndex:2,_usernameIndex:1},n={home:"/userfiles",trash:"/userfiles/.Trash",workgroup:"/groupfiles/%WORKGROUP%",network:"/networkdrives",print:"/printfiles",local:"/localfiles",_workgroupIndex:1,_usernameIndex:!1},r={notifyMap:t,cdnMap:n};return r}),define("PathInfo",[],function(){function e(e,t,n,r){this.eyeosPath=e,this.scheme=t,this.username=n,this.workgroupName=r}return e.prototype.isUserPath=function(){return this.isUserHomePath()||this.scheme==="network"},e.prototype.isUserHomePath=function(){return this.scheme==="home"},e.prototype.isWorkgroupPath=function(){return this.scheme==="workgroup"},e.prototype.isPrintPath=function(){return this.scheme==="print"},e.prototype.getUsername=function(){if(this.isWorkgroupPath())throw new Error("path "+this.eyeosPath+" is not a user or print path");if(!this.username)throw new Error("Can't get original username for path "+this.eyeosPath);return this.username},e.prototype.getWorkGroupName=function(){if(!this.isWorkgroupPath())throw new Error("path "+this.eyeosPath+" is not a workgroup path");return this.workgroupName},e.prototype.getEyeosPath=function(){return this.eyeosPath},e.prototype.getRelativePath=function(){if(!this.relativePath){var e=this.scheme.length+3;return this.isWorkgroupPath()&&(e+=this.getWorkGroupName().length+1),this.eyeosPath.substr(e)}return this.relativePath},e}),define("Resolver",["./PathInfo"],function(e){function t(e,t,r){var i=n(r.input.substr(r[0].length))||"/";if(i[0]!="/")return!1;switch(t){case"home":case"trash":case"print":case"network":case"local":return t+"://"+i;case"workgroup":return t+":///"+r[e]+i;default:return!1}}function n(e){return e.replace(/\/+$/g,"")}function r(e){var t=e.split("://")[0];return this.map.hasOwnProperty(t)?t:!1}function i(e){var t=this.map[e];return t?t:!1}function s(t,n){var r;this.map=t,this.PathInfo=n||e,this.schemeRegexes={};for(var i in this.map)this.map.hasOwnProperty(i)&&i[0]!=="_"&&(r=this.map[i].replace(/%USER%/g,"([^/]+)"),this.schemeRegexes[i]=new RegExp(r.replace(/%WORKGROUP%/g,"([^/]*)")))}return s.prototype.getPath=function(e,t){var n=r.call(this,e);if(!n)return!1;var s=i.call(this,n);if(!s)return!1;var o=e.split(/\/+/),u;if(n==="workgroup"){var a=o[1];s=s.replace("%WORKGROUP%",a),u=o.slice(2).join("/")}else u=o.slice(1).join("/");return s=s.replace("%USER%",t)+"/"+u,s},s.prototype.getEyeosPath=function(e){var n;for(var r in this.schemeRegexes)if(n=this.schemeRegexes[r].exec(e))return t(this.map._workgroupIndex,r,n);return!1},s.prototype.getSchemeList=function(){var e=[];for(var t in this.map)this.map.hasOwnProperty(t)&&t[0]!=="_"&&e.push(t);return e},s.prototype.getPathInfo=function(e){var n;for(var r in this.schemeRegexes)if(n=this.schemeRegexes[r].exec(e)){var i=t(this.map._workgroupIndex,r,n);if(i)return new this.PathInfo(i,r,n[this.map._usernameIndex],n[this.map._workgroupIndex])}return!1},s.prototype.isEyeosPathEmpty=function(e){var t=1,n,s,o=r.call(this,e);return o?i.call(this,o)?(n=e.substr(e.indexOf("://")+3),s=n.split("/"),o==="workgroup"&&(t=2),s[t].length===0):!1:!1},s.prototype.isLocalScheme=function(e){return this.schemeRegexes.local.test(e)},s}),define(["../settings","./Resolver","./pathJoin"],function(e,t,n){function r(){}return r.getResolver=function(r,i){switch(r.toLowerCase()){case"cdn":return new t(e.cdnMap);case"notify":return new t(e.notifyMap);case"filesystem":var s={};if(!i||!i.mountPoint)throw new Error("You need to pass a mountpoint to get the Resolver for "+r);for(var o in e.notifyMap)e.notifyMap.hasOwnProperty(o)&&(o[0]!=="_"?s[o]=n(i.mountPoint,e.notifyMap[o]):s[o]=e.notifyMap[o]);return new t(s);default:throw new Error("Resolver for type "+r+" does not exist.")}},r})})();